---
title: "Figures Ocean Solutions manuscript"
author: "Jean-Pierre Gattuso"
date: '`r format(Sys.Date(), "%d %B %Y")`'
output:
  html_document:
  code_folding: hide
fig_caption: yes
toc: yes
toc_float: yes
pdf_document:
  toc: yes
---
  
```{r prep, echo=FALSE, message= FALSE}
rm(list = ls())
#devtools::install_github("ricardo-bion/ggradar", dependencies=TRUE)
library(tidyverse)
library(ggradar)
library(scales)
library(readxl)
library(knitr)       # kable : prettier data.frame output
library(gridExtra)
library(RColorBrewer)
library(ggrepel)
library(grid)
library(gridExtra)
library(gtable)
library(viridis)
#library(extrafont)
Sys.setlocale("LC_ALL", "en_US.UTF-8")
#extrafont::font_import(pattern = 'Verdana', prompt=FALSE)

Sys.setenv(TZ='UTC') # on utilise UTC
dat_list <- list()
cols_blues <- colorRampPalette(brewer.pal(9,"Blues"))(6)
cols_reds <- colorRampPalette(brewer.pal(9,"Reds"))(6)
names(cols_blues) <- c("0", "1", "2", "3", "4", "5")
names(cols_reds) <- c("0", "1", "2", "3", "4", "5")

size_labs <- 6
face_font <- "plain"

Mytheme <- function(size_labs = 6, face_font="plain", ...) {
  theme_bw() +
  theme(axis.text.x = element_text(face=face_font, size=size_labs, color="black"),
        axis.title.x = element_text(face=face_font, size=size_labs, 
                                    margin=margin(0,0,0,0,"pt")),
        axis.text.y = element_text(face=face_font, color="black", size=size_labs),
        axis.title.y = element_text(face=face_font, size=size_labs),
        axis.ticks.x = element_line(size=0.1),
        axis.ticks.y = element_line(size=0.1),
        axis.ticks.length = unit(1.1, "mm"),
        panel.grid.major = element_blank(),
#        panel.grid.major = element_line(size = 0.25, color="black",
#                                        linetype="dotted"),
        #aspect.ratio = 1 / 1,
        plot.margin = margin(t = 1, r = 1, b = 1, l = 1, unit = "lines")
)
}

# Define scale for lead time
vector2recode <- c("days to months", "months", "months to years", "months to decades", "years", "years to decades", "decades")
vector2replace <- recode(vector2recode,
                         "days to months" = 7,
                         "months" = 6,
                         "months to years" = 5,
                         "months to decades" = 4,
                         "years" = 3,
                         "years to decades" = 2,
                         "decades" = 1)
vector2replaced <- scales::rescale(vector2replace, from = c(1, 7), to = c(1,5))
file_name <- "../data/Ocean Solutions Tables_2017-07-28.xlsx"
#file_name <- "../../../interim_documents/backups_google_docs/Ocean Solutions Tables_2017-07-18b.xlsx"
```

Scores for "Duration of benefits" and "Lead time"" were transformed from text to numerical, keeping in mind that the highest score is the better:

* Duration of effects:
    + "permanent" = 5
    + "centuries" = 4
    + "decades/centuries" = 3
    + "years" = 2
    + "days to months" = 1

* Lead time:
    + "days to months" = 7
    + "months" = 6
    + "months to years" = 5
    + "months to decades" = 4
    + "Years" = 3
    + "years to decades" = 2
    + "decades" = 1

The Lead time was then rescaled on a 1 to 5 scale:
    + "days to months" = 5
    + "months" = 4.3
    + "months to years" = 3.7
    + "months to decades" = 3
    + "years" = 2.3
    + "years to decades" = 1.7
    + "decades" = 1


**Feasibility** is the mean of:

* Readiness
* Lead time until full potential effectiveness

**Potential effectiveness** is the mean of:

* Effectiveness to moderate warming
* Effectiveness to moderate acidification (upper ocean/global)
* Effectiveness to moderate sea level rise

```{r prepare data figure 3, warning=FALSE, echo=FALSE, message= FALSE}
# Read and prepare global solutions
dat <- read_xlsx(path = file_name,
                  skip=8, n_max = 9, trim_ws = TRUE,
                  sheet = "T1a solutions (global)", col_names = TRUE,
                  na = c("", "NA")) %>%
  dplyr::select(-`Assessment guidance`)


# Reorganize Criteria
dat <- dat[-1,] # remove first Criteria (increase carbon uptake)
#dat$Criteria[dat$Criteria == "Effectiveness to increase net carbon uptake"] <-  "Increase carbon uptake"
dat$Criteria[dat$Criteria == "Effectiveness to moderate warming"] <-  "Moderate warming"
dat$Criteria[dat$Criteria == "Effectiveness to moderate acidification (upper ocean/global)"] <-  "Moderate acidification"
dat$Criteria[dat$Criteria == "Effectiveness to moderate sea level rise"] <-  "Moderate sea level rise"
dat$Criteria[dat$Criteria == "Duration of the effect"] <-  "Duration of the effect"
dat$Criteria[dat$Criteria == "Technological readiness"] <-  "Readiness"
dat$Criteria[dat$Criteria == "Lead time"] <-  "Lead time"
dat$Criteria[dat$Criteria == "Cost effectiveness"] <-  "Cost effectiveness"
dat$Criteria[dat$Criteria == "Global governability (scores to be validated)"] <-  "Governability"

# Recode and rescale duration of effect
vector2recode <- unname(unlist(dat[4, 2:ncol(dat)])) # Duration
vector2replace <- recode(vector2recode, 
                         "permanent" = 5,
                         "centuries" = 4,
                         "decades/centuries" = 3,
                         "years" = 2,
                         "days to months" = 1)
dat[4, 2:ncol(dat)] <- round(as.numeric(vector2replace))

# Recode and rescale lead time
vector2recode <- unname(unlist(dat[6, 2:ncol(dat)])) # Duration
vector2replace <- recode(vector2recode, #This is using the scale defined in the first chunk
                         "days to months" = 5,
                         "months" = 4.3,
                         "months to years" = 3.7,
                         "months to decades" = 3,
                         "years" = 2.3,
                         "years to decades" = 1.7,
                         "decades" = 1)
#vector2replace <- scales::rescale(vector2replace, from = c(0, 5), to = c(1,5))
dat[6, 2:ncol(dat)] <- vector2replace

# All numeric
dat <- mutate_each(dat, funs(as.numeric), 2:ncol(dat))

# Make global data frame
global_scores <- dat %>%
  dplyr::select(Criteria, ends_with("score")) %>%
  rename(Renewables = re_score, Vegetation = vg_score,
         Fertilization = fert_score, Alkalinity = alkg_score,
         Hybrids = hyb_score, Cloud = cloud_score,
         Albedo = alb_score)
global_cl <- dat %>%
  dplyr::select(Criteria, ends_with("cl")) %>%
  rename(Renewables = re_cl, Vegetation = vg_cl,
         Fertilization = fert_cl, Alkalinity = alkg_cl,
         Hybrids = hyb_cl, Cloud = cloud_cl,
         Albedo = alb_cl)

# Read and prepare local solutions
dat <- read_xlsx(path = file_name,
                  skip=8, n_max = 10, trim_ws = TRUE,
                  sheet = "T1b solutions (local)", col_names = TRUE,
                  col_types = "text") %>%
  dplyr::select(-`Assessment guidance`, -inv)

# Reorganize Criteria
dat <- dat[-1,] # remove first Criteria (increase carbon uptake)
dat$Criteria[dat$Criteria == "Effectiveness to increase net carbon uptake"] <-  "Increase carbon uptake"
dat$Criteria[dat$Criteria == "Effectiveness to moderate warming"] <-  "Moderate warming"
dat$Criteria[dat$Criteria == "Effectiveness to moderate acidification (upper ocean/global)"] <-  "Moderate acidification"
dat$Criteria[dat$Criteria == "Effectiveness to moderate relative sea level rise"] <-  "Moderate relative sea level rise"
dat$Criteria[dat$Criteria == "Duration of the effect"] <-  "Duration of the effect"
dat$Criteria[dat$Criteria == "Technological readiness"] <-  "Readiness"
dat$Criteria[dat$Criteria == "Lead time"] <-  "Lead time"
dat$Criteria[dat$Criteria == "Cost effectiveness"] <-  "Cost effectiveness"
dat$Criteria[dat$Criteria == "Global governability (scores to be validated)"] <-  "Governability"

# Recode and rescale duration of effect
vector2recode <- unname(unlist(dat[4, 2:ncol(dat)])) # Duration
vector2replace <- recode(vector2recode, 
                         "permanent" = 5,
                         "centuries" = 4,
                         "decades/centuries" = 3,
                         "years" = 2,
                         "days to months" = 1)
dat[4, 2:ncol(dat)] <- round(as.numeric(vector2replace))

# Recode and rescale lead time
vector2recode <- unname(unlist(dat[6, 2:ncol(dat)])) # Duration
vector2replace <- recode(vector2recode, #This is using the scale defined in the first chunk
                         "days to months" = 5,
                         "months" = 4.3,
                         "months to years" = 3.7,
                         "months to decades" = 3,
                         "years" = 2.3,
                         "years to decades" = 1.7,
                         "decades" = 1)
dat[6, 2:ncol(dat)] <- vector2replace

# All numeric
dat <- mutate_each(dat, funs(as.numeric), 2:ncol(dat))

# Make local data frame
local_scores <- dat %>%
  dplyr::select(Criteria, ends_with("score")) %>%
  rename(Alkalinity = alkl_score, Vegetation = vgl_score,
         Pollution = poll_score, Hydrology = hyd_score, 
         Overexploitation = res_score,
         Protection = prot_score, Evolution = evol_score,
         Relocation_Restoration = rere_score)
local_cl <- dat %>%
  dplyr::select(Criteria, ends_with("cl")) %>%
  rename(Alkalinity = alkl_cl, Vegetation = vgl_cl,
         Pollution = poll_cl, Hydrology = hyd_cl,
         Overexploitation = res_cl,
         Protection = prot_cl, Evolution = evol_cl,
         Relocation_Restoration = rere_cl)

# Save data for KAUST and others
write_csv(x = global_scores, path = "../data/table_1a.csv", col_names = TRUE)
write_csv(x = local_scores, path = "../data/table_1b.csv", col_names = TRUE)
write_csv(x = global_cl, path = "../data/table_1a_cl.csv", col_names = TRUE)
write_csv(x = local_cl, path = "../data/table_1b_cl.csv", col_names = TRUE)

# dat to plot
# feasibility is 
# Readiness + Lead time until full potential effectiveness ["Duration of the effect" left out]

# global
feasibility <- global_scores %>% 
  filter(row_number() %in% c(5:6)) %>% 
  summarise_each(funs(mean(., na.rm = TRUE)), -Criteria)
effectiveness <- global_scores %>% 
  filter(row_number() %in% c(1:3)) %>%
  summarise_each(funs(mean(., na.rm = TRUE)), -Criteria)
dat_g <- data.frame(Solution = colnames(global_scores)[-1], 
                  Feasibility = unname(unlist(feasibility)), 
                  Effectiveness_all = unname(unlist(effectiveness)),
                  Effectiveness_ow = unname(unlist(global_scores[1, 2:ncol(global_scores)])),
                  Effectiveness_oa = unname(unlist(global_scores[2, 2:ncol(global_scores)])),
                  Effectiveness_slr = unname(unlist(global_scores[3, 2:ncol(global_scores)])),
                  Cost = unname(unlist(global_scores[7, 2:ncol(global_scores)])),
                  Governability = unname(unlist(global_scores[8, 2:ncol(global_scores)])),
                  Duration = unname(unlist(global_scores[4, 2:ncol(global_scores)]))
)

# local
feasibility <- local_scores %>% 
  filter(row_number() %in% c(5:6)) %>% 
  summarise_each(funs(mean(., na.rm = TRUE)), -Criteria)
effectiveness <- local_scores %>% 
  filter(row_number() %in% c(1:3)) %>%
  summarise_each(funs(mean(., na.rm = TRUE)), -Criteria)
dat_l <- data.frame(Solution = colnames(local_scores)[-1], 
                  Feasibility = unname(unlist(feasibility)), 
                  Effectiveness_all = unname(unlist(effectiveness)),
                  Effectiveness_ow = unname(unlist(local_scores[1, 2:ncol(local_scores)])),
                  Effectiveness_oa = unname(unlist(local_scores[2, 2:ncol(local_scores)])),
                  Effectiveness_slr = unname(unlist(local_scores[3, 2:ncol(local_scores)])),
                  Cost = unname(unlist(local_scores[7, 2:ncol(local_scores)])),
                  Governability = unname(unlist(local_scores[8, 2:ncol(local_scores)])),
                  Duration = unname(unlist(local_scores[4, 2:ncol(local_scores)]))
)

# Save data for KAUST and others
tmp <- rbind(dat_g, dat_l)
write_csv(x = dplyr::select(tmp, Solution, Feasibility), 
          path = "../data/table_1_technical_feasibility.csv", 
          col_names = TRUE)

dat_g$Solution <- c("Renew", "Vg", "Fert", "Alkg", "Hyb", "Cl", "Alb")

dat_l$Solution <- c("Alkl", "Vl", "Poll", "Hyd", "Over", "Prot", "Evol", "RR")
```

```{r}
mtcars %>%
     rownames_to_column( var = "group" ) %>%
     mutate_at(vars(-group),funs(rescale)) %>%
     tail(4) %>% select(1:10) -> mtcars_radar
ggradar(mtcars_radar,font.radar = "Helvetica") 

d <- dat_g %>%
  dplyr::mutate(Duration=factor(Duration, levels = c(1:5))) %>%
  dplyr::mutate(Governability=round(Governability, digits=0))%>%
  filter(Solution=="Alb") %>%
  gather(Criteria, value, -Solution) %>% 
  spread(Solution, value) %>%
  as.tibble()
  ggradar
  
  d <- 

```

```{r plot figure 4 global, warning=FALSE, echo=FALSE, message= FALSE}
d <- as.tibble(dat_g) %>%
  dplyr::mutate(Duration=factor(Duration, levels = c(1:5))) %>%
  dplyr::mutate(Governability=round(Governability, digits=0))
# if needed labels = c("days to months", "years", "decades to centuries", "centuries", "permanent")
fig4a_all <- ggplot(data = d,
                  aes(x= Effectiveness_all, 
                      y = Feasibility,
                      label = Solution)) +
  scale_x_continuous(limits=c(-0.5, 6), expand = c(0, 0), 
                     breaks = 1:5, minor_breaks = NULL) +
  scale_y_continuous(limits=c(0, 6), expand = c(0, 0), 
                     breaks = 1:5, minor_breaks = NULL)  +
  geom_point(aes(size = Governability, col = Duration)) +
  scale_color_viridis(name = "Duration of\nthe effect", option="D",
                      discrete = TRUE, limits=c(1:5)) +
  guides(colour = guide_legend(override.aes = list(size=5))) +
  scale_size_continuous(name = "Governability", 
                        range = c(2, 8), limits = c(1, 5)) +
  geom_text_repel(aes(fill = "white"), size = 4, nudge_y = 0.5,
                  lineheight=.8, segment.colour = "black") +
  geom_hline(yintercept = 3, size = 0.3, col = "gray75") +
  geom_vline(xintercept = 3, size = 0.3, col = "gray75") +
  labs(x = "Potential total effectiveness", y = "Technical feasibility",
       subtitle = NULL,
       caption = NULL) +
  annotation_custom(grid::textGrob("A", gp=gpar(fontsize=14, fontface="bold")), xmin=-0.25, xmax=-0.25, ymin=5.75, ymax=5.75)+
  coord_equal() +
  Mytheme(size_labs = 12) +
  theme(axis.title.x = element_text(margin = margin(5,0,0,0)),
        legend.title = element_text(size = 12),
        legend.text = element_text(size = 12),
        legend.key = element_rect(size = 1),
        legend.key.height = unit(0.5, "cm"),
        legend.key.width = unit(0.5, "cm"),
        legend.position = "right",
        legend.direction = "vertical")
fig4a_all

fig4a_ow <- ggplot(data = d,
                  aes(x= Effectiveness_ow, 
                      y = Feasibility,
                      label = Solution)) +
  scale_x_continuous(limits=c(-0.5, 6), expand = c(0, 0), 
                     breaks = 1:5, minor_breaks = NULL) +
  scale_y_continuous(limits=c(0, 6), expand = c(0, 0), 
                     breaks = 1:5, minor_breaks = NULL)  +
  geom_point(aes(size = Governability, col = Duration)) +
  scale_color_viridis(name = "Duration of\nthe effect", option="D",                       discrete = TRUE, limits=c(1:5)) +   
  guides(colour = guide_legend(override.aes = list(size=5))) +
  scale_size_continuous(name = "Governability", 
                        range = c(2, 8), limits = c(1, 5)) +
  geom_text_repel(aes(fill = "white"), size = 4, nudge_y = 0.5,
                  lineheight=.8, segment.colour = "black") +
  geom_hline(yintercept = 3, size = 0.3, col = "gray75") +
  geom_vline(xintercept = 3, size = 0.3, col = "gray75") +
  labs(x = "Potential effectiveness to moderate\nocean warming", 
       y = "Technical feasibility",
       #title = "Fig. 2: potential effectiveness of global solutions\nto moderate warming",
       subtitle = NULL,
       caption = NULL) +
  annotation_custom(grid::textGrob("B", gp=gpar(fontsize=14, fontface="bold")), xmin=-0.25, xmax=-0.25, ymin=5.75, ymax=5.75)+
  coord_equal() +
  Mytheme(size_labs = 12) +
  theme(axis.title.x = element_text(margin = margin(5,0,0,0)),         legend.title = element_text(size = 12),
        legend.text = element_text(size = 12),
        legend.key = element_rect(size = 1),
        legend.key.height = unit(0.5, "cm"),
        legend.key.width = unit(0.5, "cm"),
        legend.position = "right",
        legend.direction = "vertical")
fig4a_ow

fig4a_oa <- ggplot(data = d,
                  aes(x= Effectiveness_oa, 
                      y = Feasibility,
                      label = Solution)) +
  scale_x_continuous(limits=c(-0.5, 6), expand = c(0, 0), 
                     breaks = 1:5, minor_breaks = NULL) +
  scale_y_continuous(limits=c(0, 6), expand = c(0, 0), 
                     breaks = 1:5, minor_breaks = NULL)  +
  geom_point(aes(size = Governability, col = Duration)) +
  scale_color_viridis(name = "Duration of\nthe effect", option="D",                       discrete = TRUE, limits=c(1:5)) +   
  guides(colour = guide_legend(override.aes = list(size=5))) +
  scale_size_continuous(name = "Governability", 
                        range = c(2, 8), limits = c(1, 5)) +
  geom_text_repel(aes(fill = "white"), size = 4, nudge_y = 0.5,
                  lineheight=.8, segment.colour = "black") +
  geom_hline(yintercept = 3, size = 0.3, col = "gray75") +
  geom_vline(xintercept = 3, size = 0.3, col = "gray75") +
  labs(x = "Potential effectiveness to moderate\nocean acidification", 
       y = "Technical feasibility",
       #title = "Fig. 2: potential effectiveness of global solutions\nto moderate ocean acidification",
       subtitle = NULL,
       caption = NULL) +
  annotation_custom(grid::textGrob("C", gp=gpar(fontsize=14, fontface="bold")), xmin=-0.25, xmax=-0.25, ymin=5.75, ymax=5.75)+
  coord_equal() +
  Mytheme(size_labs = 12) +
  theme(axis.title.x = element_text(margin = margin(5,0,0,0)),         legend.title = element_text(size = 12),
        legend.text = element_text(size = 12),
        legend.key = element_rect(size = 1),
        legend.key.height = unit(0.5, "cm"),
        legend.key.width = unit(0.5, "cm"),
        legend.position = "right",
        legend.direction = "vertical")
fig4a_oa

fig4a_slr <- ggplot(data = d,
                  aes(x= Effectiveness_slr, 
                      y = Feasibility,
                      label = Solution)) +
  scale_x_continuous(limits=c(-0.5, 6), expand = c(0, 0), 
                     breaks = 1:5, minor_breaks = NULL) +
  scale_y_continuous(limits=c(0, 6), expand = c(0, 0), 
                     breaks = 1:5, minor_breaks = NULL)  +
  geom_point(aes(size = Governability, col = Duration)) +
  scale_color_viridis(name = "Duration of\nthe effect", option="D",                       discrete = TRUE, limits=c(1:5)) +   guides(colour = guide_legend(override.aes = list(size=5))) +
  scale_size_continuous(name = "Governability", 
                        range = c(2, 8), limits = c(1, 5)) +
  geom_text_repel(aes(fill = "white"), size = 4, nudge_y = 0.5,
                  lineheight=.8, segment.colour = "black") +
  geom_hline(yintercept = 3, size = 0.3, col = "gray75") +
  geom_vline(xintercept = 3, size = 0.3, col = "gray75") +
 labs(x = "Potential effectiveness to moderate\n sea level rise", y = "Technical feasibility",
       #title = "Fig. 2: potential effectiveness of global solutions\nto moderate sea level rise ",
       subtitle = NULL,
       caption = NULL) +
  annotation_custom(grid::textGrob("D", gp=gpar(fontsize=14, fontface="bold")), xmin=-0.25, xmax=-0.25, ymin=5.75, ymax=5.75)+
  coord_equal() +
  Mytheme(size_labs = 12) +
  theme(axis.title.x = element_text(margin = margin(5,0,0,0)),         legend.title = element_text(size = 12),
        legend.text = element_text(size = 12),
        legend.key = element_rect(size = 1),
        legend.key.height = unit(0.5, "cm"),
        legend.key.width = unit(0.5, "cm"),
        legend.position = "right",
        legend.direction = "vertical")
fig4a_slr

```

```{r plot figure 4 local, warning=FALSE, echo=FALSE, message= FALSE}
d <- as.tibble(dat_l) %>%
  dplyr::mutate(Duration=factor(Duration, levels = c(1:5)))

fig4b_all <- ggplot(data = d,
                  aes(x= Effectiveness_all, 
                      y = Feasibility,
                      label = Solution)) +
  scale_x_continuous(limits=c(-0.5, 6), expand = c(0, 0), 
                     breaks = 1:5, minor_breaks = NULL) +
  scale_y_continuous(limits=c(0, 6), expand = c(0, 0), 
                     breaks = 1:5, minor_breaks = NULL)  +
  geom_point(aes(size = Governability, col = Duration)) +
  scale_color_viridis(name = "Duration of\nthe effect", option="D",                       discrete = TRUE, limits=c(1:5)) +   
  guides(colour = guide_legend(override.aes = list(size=5))) +
  scale_size_continuous(name = "Governability", 
                        range = c(2, 8), limits = c(1, 5)) +
  geom_text_repel(aes(fill = "white"), size = 4, nudge_y = 0.5,
                  lineheight=.8, segment.colour = "black") +
  geom_hline(yintercept = 3, size = 0.3, col = "gray75") +
  geom_vline(xintercept = 3, size = 0.3, col = "gray75") +
  labs(x = "Potential total effectiveness", y = "Technical feasibility",
       subtitle = NULL,
       caption = NULL) +
  annotation_custom(grid::textGrob("E", gp=gpar(fontsize=14, fontface="bold")), xmin=-0.25, xmax=-0.25, ymin=5.75, ymax=5.75)+
  coord_equal() +
  Mytheme(size_labs = 12) +
  theme(axis.title.x = element_text(margin = margin(5,0,0,0)),         legend.title = element_text(size = 12),
        legend.text = element_text(size = 12),
        legend.key = element_rect(size = 1),
        legend.key.height = unit(0.5, "cm"),
        legend.key.width = unit(0.5, "cm"),
        legend.position = "right",
        legend.direction = "vertical")
fig4b_all

fig4b_ow <- ggplot(data = d,
                  aes(x= Effectiveness_ow, 
                      y = Feasibility,
                      label = Solution)) +
  scale_x_continuous(limits=c(-0.5, 6), expand = c(0, 0), 
                     breaks = 1:5, minor_breaks = NULL) +
  scale_y_continuous(limits=c(0, 6), expand = c(0, 0), 
                     breaks = 1:5, minor_breaks = NULL)  +
  geom_point(aes(size = Governability, col = Duration)) +
  scale_color_viridis(name = "Duration of\nthe effect", option="D",                       discrete = TRUE, limits=c(1:5)) +   
  guides(colour = guide_legend(override.aes = list(size=5))) +
  scale_size_continuous(name = "Governability", 
                        range = c(2, 8), limits = c(1, 5)) +
  geom_text_repel(aes(fill = "white"), size = 4, nudge_y = 0.5,
                  lineheight=.8, segment.colour = "black") +
  geom_hline(yintercept = 3, size = 0.3, col = "gray75") +
  geom_vline(xintercept = 3, size = 0.3, col = "gray75") +
  labs(x = "Potential effectiveness to moderate\nlocal warming", y = "Technical feasibility",
       #title = "Fig. 2: potential effectiveness of local solutions\nto moderate warming",
       subtitle = NULL,
       caption = NULL) +
  annotation_custom(grid::textGrob("F", gp=gpar(fontsize=14, fontface="bold")), xmin=-0.25, xmax=-0.25, ymin=5.75, ymax=5.75)+
  coord_equal() +
  Mytheme(size_labs = 12) +
  theme(axis.title.x = element_text(margin = margin(5,0,0,0)),         legend.title = element_text(size = 12),
        legend.text = element_text(size = 12),
        legend.key = element_rect(size = 1),
        legend.key.height = unit(0.5, "cm"),
        legend.key.width = unit(0.5, "cm"),
        legend.position = "right",
        legend.direction = "vertical")
fig4b_ow

fig4b_oa <- ggplot(data = d,
                  aes(x= Effectiveness_oa, 
                      y = Feasibility,
                      label = Solution)) +
  scale_x_continuous(limits=c(-0.5, 6), expand = c(0, 0), 
                     breaks = 1:5, minor_breaks = NULL) +
  scale_y_continuous(limits=c(0, 6), expand = c(0, 0), 
                     breaks = 1:5, minor_breaks = NULL)  +
  geom_point(aes(size = Governability, col = Duration)) +
  scale_color_viridis(name = "Duration of\nthe effect", option="D",                       discrete = TRUE, limits=c(1:5)) +   
  guides(colour = guide_legend(override.aes = list(size=5))) +
  scale_size_continuous(name = "Governability", 
                        range = c(2, 8), limits = c(1, 5)) +
  geom_text_repel(aes(fill = "white"), size = 4, nudge_y = 0.5,
                  lineheight=.8, segment.colour = "black") +
  geom_hline(yintercept = 3, size = 0.3, col = "gray75") +
  geom_vline(xintercept = 3, size = 0.3, col = "gray75") +
  labs(x = "Potential effectiveness to moderate\nlocal acidification", 
       y = "Technical feasibility",
       #title = "Fig. 2: potential effectiveness of local solutions\nto moderate ocean acidification",
       subtitle = NULL,
       caption = NULL) +
  annotation_custom(grid::textGrob("G", gp=gpar(fontsize=14, fontface="bold")), xmin=-0.25, xmax=-0.25, ymin=5.75, ymax=5.75)+
  coord_equal() +
  Mytheme(size_labs = 12) +
  theme(axis.title.x = element_text(margin = margin(5,0,0,0)),         legend.title = element_text(size = 12),
      legend.text = element_text(size = 10),
        legend.key = element_rect(size = 1),
        legend.key.height = unit(0.5, "cm"),
        legend.key.width = unit(0.5, "cm"),
        legend.position = "right",
        legend.direction = "vertical")
fig4b_oa

fig4b_slr <- ggplot(data = d,
                  aes(x= Effectiveness_slr, 
                      y = Feasibility,
                      label = Solution)) +
  scale_x_continuous(limits=c(-0.5, 6), expand = c(0, 0), 
                     breaks = 1:5, minor_breaks = NULL) +
  scale_y_continuous(limits=c(0, 6), expand = c(0, 0), 
                     breaks = 1:5, minor_breaks = NULL)  +
  geom_point(aes(size = Governability, col = Duration)) +
  scale_color_viridis(name = "Duration of\nthe effect", option="D",                       discrete = TRUE, limits=c(1:5)) +   
  guides(colour = guide_legend(override.aes = list(size=5))) +
  scale_size_continuous(name = "Governability", 
                        range = c(2, 8), limits = c(1, 5)) +
  geom_text_repel(aes(fill = "white"), size = 4, nudge_y = 0.5,
                  lineheight=.8, segment.colour = "black") +
  geom_hline(yintercept = 3, size = 0.3, col = "gray75") +
  geom_vline(xintercept = 3, size = 0.3, col = "gray75") +
  labs(x = "Potential effectiveness to moderate\nrelative sea level rise", y = "Technical feasibility",
       #title = "Potential effectiveness of local solutions\nto moderate relative sea level rise ",
       subtitle = NULL,
       caption = NULL) +
  annotation_custom(grid::textGrob("H", gp=gpar(fontsize=14, fontface="bold")), xmin=-0.25, xmax=-0.25, ymin=5.75, ymax=5.75)+
  coord_equal() +
  Mytheme(size_labs = 12) +
  theme(axis.title.x = element_text(margin = margin(5,0,0,0)),         legend.title = element_text(size = 12),
        legend.text = element_text(size = 12),
        legend.key = element_rect(size = 1),
        legend.key.height = unit(0.5, "cm"),
        legend.key.width = unit(0.5, "cm"),
        legend.position = "right",
        legend.direction = "vertical")
fig4b_slr
```

```{r Fig. 4 combine plots, warning=FALSE, echo=FALSE, message= FALSE}
g <- arrangeGrob(fig4a_all, fig4b_all, 
                 fig4a_ow, fig4b_ow, 
                 fig4a_oa, fig4b_oa, 
                 fig4a_slr, fig4b_slr, 
                 ncol=2)
ggsave(paste0("../figs/fig4_", Sys.Date(), ".pdf"), g, dpi = 300, width = 25, height = 40, unit = "cm")
ggsave(paste0("../figs/fig4_", Sys.Date(), ".eps"), g, dpi = 300, width = 25, height = 40, unit = "cm")
ggsave(paste0("../figs/fig4_", Sys.Date(), ".png"), g, dpi = 300, width = 25, height = 40, unit = "cm")
```

```{r Fig. sensitivity, warning=FALSE, echo=FALSE, message= FALSE}
dat <- read_xlsx(path = file_name,
                  skip=8, n_max = 8, trim_ws = TRUE,
                  sheet = "T2 Sensitivity", col_names = TRUE,
                  col_types = "text") %>%
  dplyr::select(-c(`Assessment guidance`, Caveats, `Who?`))

dat$System[dat$System == "Shellfish fisheries and aquaculture"] <-  "Shellfish fisheries\nand aquaculture"
dat$System[dat$System == "Mangroves and salt-marshes"] <-  "Mangroves and\nsalt-marshes"

# All numeric
dat <- mutate_each(dat, funs(as.numeric), 2:ncol(dat))
dat <- dat[c(2,8,1, 3:7),] #in a specific order
dat$System <- factor(dat$System, levels=dat$System)

# Make data frames
sensitivity_scores <- dat %>%
  dplyr::select(System, ends_with("score")) %>%
  rename(Warming = ow_score, Acidification = oa_score,
         `Sea level rise` = slr_score)
sensitivity_cl <- dat %>%
  dplyr::select(System, ends_with("cl")) %>%
  rename(Warming = ow_cl, Acidification = oa_cl,
         `Sea level rise` = slr_cl)

# Save data for KAUST and others
write_csv(x = sensitivity_scores, path = "../data/table_2.csv", col_names = TRUE)
write_csv(x = sensitivity_cl, path = "../data/table_2_cl.csv", col_names = TRUE)

d <- tidyr::gather(data = sensitivity_scores, key = Driver, value = score, 2:4)



# Plot ecosystems
patterns <- c("Coral", "Mangrove", "Seagrass", "Arctic")
d_ecosystems <- d %>%
  dplyr::filter(grepl(paste(patterns, collapse="|"), System)) %>%
                  mutate(Driver = factor(Driver,
                                         levels=unique(Driver)))
fig_sensitivity_A <- ggplot(data = d_ecosystems,
                 aes(y=Driver,
                     x=System,
                     fill=factor(score, levels=0:5)
                 )) +
   #                  label = cl)) +
  labs(x = NULL, y = NULL,
       title = "A: Sensitivity of key ecosystems",
       caption = NULL) +
  geom_tile(color="black", size=0.1) +
  scale_fill_manual(values = cols_blues,
                    na.value = "gray90",
                    name = NULL,
                    guide = "legend",
                    labels = c("Nil", "Very low", "Low", "Moderate",
                                   "High", "Very high"),
                    drop = FALSE) +
  scale_x_discrete(position = "top") +
  coord_equal() +
  guides(fill = guide_legend(reverse = TRUE)) +
  scale_y_discrete(limits = rev(levels(d_ecosystems$Driver))) +
  Mytheme(size_labs = 12) +
  theme(axis.text.x = element_text(angle = 45, hjust = 0, vjust = 0.5),
        title = element_text(face = "bold"),
        panel.border = element_rect(linetype= "blank"),
        legend.text = element_text(size = 10),
        legend.key = element_rect(size = 1),
        legend.key.height = unit(0.5, "cm"),
        legend.key.width = unit(0.5, "cm"),
        legend.position = "right",
        legend.direction = "vertical")
#  geom_text(aes(colour = factor(score, levels=0:5))) +
#  scale_color_manual(values = c("black", "black", "black", "white", "white", "white"), guide = FALSE)
fig_sensitivity_A

# Plot ecosystem services
patterns <- c("Fish", "Fin", "Shellfish", "protection")
d_services <- d %>%
  dplyr::filter(grepl(paste(patterns, collapse="|"), System)) %>%
                  mutate(Driver = factor(Driver,
                                         levels=unique(Driver)))
fig_sensitivity_B <- ggplot(data = dplyr::filter(d_services, grepl(paste(patterns, collapse="|"), System)),
                 aes(y=Driver,
                     x=System,
                     fill=factor(score, levels=0:5)
                 )) +
   #                  label = cl)) +
  labs(x = NULL, y = NULL,
       title = "B: Sensitivity of key ecosystem services",
       caption = NULL) +
  geom_tile(color="black", size=0.1) +
  scale_fill_manual(values = cols_blues,
                    na.value = "gray90",
                    name = NULL,
                    guide = "legend",
                    labels = c("Nil", "Very low", "Low", "Moderate",
                                   "High", "Very high"),
                    drop = FALSE) +
  scale_x_discrete(position = "top") +
  coord_equal() +
  guides(fill = guide_legend(reverse = TRUE)) +
  scale_y_discrete(limits = rev(levels(d_services$Driver))) +
  Mytheme(size_labs = 12) +
  theme(axis.text.x = element_text(angle = 45, hjust = 0, vjust = 0.5),
        title = element_text(face = "bold"),
        panel.border = element_rect(linetype= "blank"),
        legend.text = element_text(size = 10),
        legend.key = element_rect(size = 1),
        legend.key.height = unit(0.5, "cm"),
        legend.key.width = unit(0.5, "cm"),
        legend.position = "right",
        legend.direction = "vertical")
fig_sensitivity_B

# Combine
lay <- rbind(1,2)
g <- grid.arrange(grobs = list(fig_sensitivity_A, fig_sensitivity_B), layout_matrix = lay)
ggsave(paste0("../figs/fig_sensitivity_", Sys.Date(), ".pdf"), g, dpi = 300, width = 20, height = 25, unit = "cm")
ggsave(paste0("../figs/fig_sensitivity_", Sys.Date(), ".png"), g, dpi = 300, width = 20, height = 25, unit = "cm")
```

```{r Figure contribution ecosystems and services, warning=FALSE, echo=FALSE, message= FALSE}
dat <- read_xlsx(path = file_name,
                  skip=9, n_max = 57, trim_ws = TRUE,
                  sheet = "T3_Systems-Ocean", col_names = TRUE,
                  col_types = "text") %>%
  dplyr::select(-c(`Assessment guidance`, INV)) %>%
  dplyr::filter(!grepl("Caveats and limits", Criteria))

dat$Criteria[dat$Criteria == "Effectiveness to reduce impacts from warming (T1a or T1b with T2)"] <-  "Warming"
dat$Criteria[dat$Criteria == "Effectiveness to reduce impacts from ocean acidification (T1a or T1b with T2)"] <-  "Acidification"
dat$Criteria[dat$Criteria == "Effectiveness to reduce impacts from sea level rise (T1a or T1b with T2)"] <-  "Sea level rise"
dat$Criteria[dat$Criteria == "Effectiveness of solution to reduce climate impacts on this ecosystem or service by reducing other drivers"] <-  "Other drivers"
dat$Criteria[dat$Criteria == "Importance of co-benefits for this ecosystem or service"] <-  "Cobenefits"
dat$Criteria[dat$Criteria == "Lack of unintended consequences"] <- "Lack_unintended"

dat$Category[dat$Category == "Coastal protection by natural ecosystems"] <- "Coastal protection"
dat$Category[dat$Category == "Mangroves and salt-marshes"] <-  "Mangroves and salt-marshes"

# All numeric
dat <- mutate_each(dat, funs(as.numeric), 3:ncol(dat))

# Make data frames
impacts_scores <- dat %>%
  dplyr::select(Category, Criteria, ends_with("score")) %>%
  rename(Renewables = re_score, Vegetation_g = vg_score,
         Fertilization = fert_score, Alkalinity_g = alkg_score,
         Hybrids = hyb_score, Cloud = cloud_score,
         Albedo = alb_score, Alkalinity_l = alkl_score, Vegetation_l = vgl_score,
         Pollution = poll_score, Hydrology = hyd_score, 
         Overexploitation = res_score,
         Protection = prot_score, Evolution = evol_score,
         Relocation_Restoration = rere_score)
impacts_cl <- dat %>%
   dplyr::select(Category, Criteria, ends_with("cl")) %>%
  rename(Renewables = re_cl, Vegetation_g = vg_cl,
         Fertilization = fert_cl, Alkalinity_g = alkg_cl,
         Hybrids = hyb_cl, Cloud = cloud_cl,
         Albedo = alb_cl, Alkalinity_l = alkl_cl, Vegetation_l = vgl_cl,
         Pollution = poll_cl, Hydrology = hyd_cl, 
         Overexploitation = res_cl,
         Protection = prot_cl, Evolution = evol_cl,
         Relocation_Restoration = rere_cl)

# Save data for KAUST and others
write_csv(x = impacts_scores, path = "../data/table_3.csv", col_names = TRUE)
write_csv(x = impacts_cl, path = "../data/table_3_cl.csv", col_names = TRUE)

impacts_scores <- impacts_scores %>% 
  rename(Renew = Renewables, Vg = Vegetation_g, Fert = Fertilization, Alkg = Alkalinity_g,
         Hyb = Hybrids, Cl = Cloud, Alb = Albedo, Alkl = Alkalinity_l,
         Vl = Vegetation_l, Poll = Pollution, Hyd = Hydrology, Over = Overexploitation,
         Prot = Protection, Evol = Evolution, RR = Relocation_Restoration)

c <- unique(impacts_scores$Category)
compilation <- NULL
panel_number <- LETTERS[1:8]
for (i in 1:length(c)) { #
#i <- 5
cat <- c[i]
tmp <- impacts_scores %>%
  dplyr::filter(Category == cat) %>%
  dplyr::select(-Category)
effectiveness <- tmp %>% # Aggregate effectivenesses
  filter(row_number() %in% c(1:3)) %>%
  summarise_each(funs(mean(., na.rm = TRUE)), -Criteria)
effectiveness <- unname(unlist(c("Effectiveness", as.numeric(effectiveness))))
tmp <- rbind(tmp, effectiveness)
d <- as.tibble(t(tmp[, -1]))
colnames(d) <- unname(unlist(tmp[, 1]))

# reverse scale disbenefits
d <- d %>%
  dplyr::mutate(Disbenefits = recode(Lack_unintended, "1" = "5", "2" = "4", "3" = "3", "4" = "2", "5" = "1")) %>%
  dplyr::mutate_all(funs(as.numeric)) %>% # All numeric
  dplyr::mutate(co_dis = Cobenefits/Disbenefits) %>%
  dplyr::mutate(Solution = colnames(tmp)[-1]) %>%
  dplyr::mutate(scale = c(rep("global", 7), rep("local", 8))) %>%
  dplyr::mutate(System = c(rep(cat, 15)))

compilation <- rbind(compilation, d) # to compile d for all systems

# Plots
p <- ggplot(data = d) +
  geom_point(aes(x = Effectiveness,
                 y = co_dis, col= scale,
                 size = `Other drivers`), alpha=0.5) +
  guides(colour = guide_legend(override.aes = list(size=3))) +
  geom_text_repel(aes(x = Effectiveness,
               y = co_dis, fill = "white", label = Solution), 
               size = 3, nudge_y = 0.3, lineheight=.8) +
  scale_x_continuous(limits=c(-1, 6), expand = c(0, 0), 
                     breaks = 0:5, minor_breaks = NULL) +
  scale_color_discrete(name = NULL) +
  scale_size_continuous(limits=c(1, 5), range=c(2, 8), name = "Reduce\nother\ndrivers") +
  scale_y_continuous(limits=c(-1, 6), expand = c(0, 0), 
                     breaks = 0:5, minor_breaks = NULL)  +
  geom_hline(yintercept = 1, linetype = "dotted", size = 0.3) +
  geom_hline(yintercept = 3, size = 0.3, col = "gray75") +
  geom_vline(xintercept = 3, size = 0.3, col = "gray75") +
  labs(x = "Combined potential effectiveness", y = "Ratio cobenefits/disbenefits",
       subtitle = NULL,
       caption = NULL) +
  coord_equal() +
  Mytheme(size_labs = 10) +
  theme(axis.title.x = element_text(margin = margin(5,0,0,0)),
        legend.text = element_text(size = 10),
        legend.key = element_rect(size = 1),
        legend.key.height = unit(0.5, "cm"),
        legend.key.width = unit(0.5, "cm"),
        legend.position = "right",
        legend.direction = "vertical"
        )
g <- ggplotGrob(p)
g <- gtable_add_grob(g, grobTree(textGrob(paste0(panel_number[i], ": ", cat), x=0, hjust=0, gp=gpar(fontsize=9, fontface = "bold"))), t=1, l=4)
plot_name <- gsub(" ", "_", cat, fixed = TRUE)
assign(plot_name, g)
}

# Save data for KAUST and others
write_csv(x = compilation, path = "../data/table_3_mean_effectiveness.csv", col_names = TRUE)

# Combine
lay <- rbind(c(1, 5),
             c(2, 6),
             c(3, 7),
             c(4, 8))
g <- grid.arrange(grobs = list(Coral_reefs, Mangroves_and_saltmarshes, Seagrass_habitats, Arctic_biota, Fin_fisheries, Fish_aquaculture, Coastal_protection,  Bivalves_fisheries_and_aquaculture), layout_matrix = lay)
ggsave(paste0("../figs/fig_eco_services_", Sys.Date(), ".pdf"), g, dpi = 300, width = 20, height = 25, unit = "cm")
ggsave(paste0("../figs/fig_eco_services_", Sys.Date(), ".png"), g, dpi = 300, width = 20, height = 25, unit = "cm")
```


```{r Uncertainties, warning=FALSE, echo=FALSE, message= FALSE}
# Prepare data
t1a <- read_csv(file = "../data/table_1a_cl.csv", col_names = TRUE) %>%
  dplyr::rename(Alkalinity_g = Alkalinity, Vegetation_g = Vegetation)
t1b <- read_csv(file = "../data/table_1b_cl.csv", col_names = TRUE) %>%
  dplyr::rename(Alkalinity_l = Alkalinity, Vegetation_l = Vegetation)
t1 <- dplyr::full_join(t1a, t1b) %>%
  dplyr::select(Criteria, Renewables, Vegetation_g, Fertilization, Alkalinity_g, Hybrids, Cloud, Albedo, Alkalinity_l,
         Vegetation_l, Pollution, Hydrology, Overexploitation, Protection, Evolution, Relocation_Restoration)
# tmp <- t1 %>%
#   tidyr::gather(key = Solutions, val, 2:ncol(t1)) %>%
#   tidyr::spread(Criteria, val) %>%
#   dplyr::select(-`Duration of the effect`, -`Global governability`, 
#                 -`Lead time until full potential effectiveness`) %>%
#   tidyr::unite(col = `moderate slr`, c(`Moderate relative sea level rise`, `Moderate sea level rise`)) %>%
#   dplyr::mutate(`moderate slr`, gsub("NA", "", cat, fixed = TRUE))

t3 <- read_csv(file = "../data/table_3_cl.csv", col_names = TRUE) %>%
  dplyr::mutate(cat_crit = paste0(Category, "_", Criteria)) %>%
  dplyr::select(cat_crit, Renewables, Vegetation_g, Fertilization, Alkalinity_g, Hybrids, Cloud, Albedo, Alkalinity_l, Vegetation_l, Pollution, Hydrology, Overexploitation, Protection, Evolution, Relocation_Restoration) %>%
  dplyr::rename(Criteria = cat_crit)

# translate t1
d <- t(t1)
colnames(d) <- d[1,]
d <- as.data.frame(d[-1,]) #remove colnames
d <- d %>%
  dplyr::mutate(Solutions = rownames(d)) %>%
  dplyr::select(-`Duration of the effect`, -`Lead time until full potential effectiveness`,
                -`Global governability`) %>% # remove columns for which there is no data
  dplyr::mutate_at(vars(-Solutions), funs(as.integer)) %>%
  tidyr::gather(1:6, key=Criteria, value = cl)
d$cl <- factor(d$cl, levels=c("NA", as.character(0:5)), exclude = NULL)

p <- ggplot(d, aes(x = Solutions, y = Criteria, fill= cl)) +
  geom_tile(colour="white") +
  scale_fill_manual(values = cols_blues,
                    breaks = 0:5) +
  scale_y_discrete(limits = rev(levels(d$Driver))) +
  #ylim(c(0, 50)) +
  coord_polar(theta="x") +
  theme(panel.background=element_blank(),
    axis.title=element_blank(),
    panel.grid=element_blank(),
    axis.text.x=element_blank(),
    axis.ticks=element_blank(),
    axis.text.y=element_text(size=5))+ theme(axis.title.y=element_blank(),
        axis.text.y=element_blank(),
        axis.ticks.y=element_blank())
lab = textGrob((paste("G  MIN  PTS  FGM  FGA  FGP  FTM  FTA  FTP  X3PM X3PA X3PP ORB DRB  TRB  AST  STL  BLK  TO  PF")),
   x = unit(.1, "npc"), just = c("left"), 
   gp = gpar(fontsize = 7))

gp = ggplotGrob(p)
gp = gtable_add_rows(gp, unit(10, "grobheight", lab), -1)
gp = gtable_add_grob(gp, lab, t = -2, l = gp$layout[gp$layout$name == "panel",]$l)

grid.newpage()
grid.draw(gp)
```


